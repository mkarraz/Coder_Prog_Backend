(()=>{"use strict";var t={514:t=>{t.exports=require("knex")}},e={};function i(r){var o=e[r];if(void 0!==o)return o.exports;var n=e[r]={exports:{}};return t[r](n,n.exports,i),n.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var r in e)i.o(e,r)&&!i.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{const t=require("express");var e=i.n(t);const r=require("fs");var o=i.n(r),n=function(t,e,i,r){return new(i||(i=Promise))((function(o,n){function s(t){try{c(r.next(t))}catch(t){n(t)}}function d(t){try{c(r.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,d)}c((r=r.apply(t,e||[])).next())}))};const s=new class{constructor(t){this.writeFile=t=>n(this,void 0,void 0,(function*(){try{yield o().promises.writeFile(this.filePath,JSON.stringify(t))}catch(t){console.log("Method writeFile: ",t)}})),this.readFile=()=>n(this,void 0,void 0,(function*(){try{return(yield o().promises.readFile(this.filePath,"utf8"))?JSON.parse(yield o().promises.readFile(this.filePath,"utf8")):[]}catch(t){if(-2===t.errno)try{return yield o().promises.writeFile(this.filePath,JSON.stringify([])),[]}catch(t){console.error("Could not create file in such directory. ",t)}else console.log("Method readFile: ",t);return[]}})),this.filePath=t}getAll(){return n(this,void 0,void 0,(function*(){return yield this.readFile()}))}getById(t){var e;return n(this,void 0,void 0,(function*(){try{const i=yield this.readFile();return null!==(e=i.find((e=>e.id===t)))&&void 0!==e?e:{error:"Product not found"}}catch(t){console.log("Method getById: ",t)}return{error:"fetch item method failed"}}))}addProduct(t){return n(this,void 0,void 0,(function*(){try{const e=yield this.readFile(),i=0===e.length?1:Math.max(...e.map((t=>t.id)))+1,r=(new Date).toLocaleString("es-AR");return e.push(Object.assign(Object.assign({},t),{id:i,timestamp:r})),yield this.writeFile(e),i}catch(t){console.log("Method save: ",t)}}))}updateProductById(t,e){return n(this,void 0,void 0,(function*(){try{const i=(yield this.readFile()).map((i=>i.id===t?Object.assign(Object.assign({},i),e):i));yield this.writeFile(i)}catch(t){console.log("Method update: ",t)}}))}deleteProductById(t){return n(this,void 0,void 0,(function*(){try{const e=yield this.readFile(),i=e.filter((e=>e.id!==t));return e.length===i.length?`There is NO product with id= ${t}`:(yield this.writeFile(i),`Product ${t} deleted`)}catch(t){console.log("Method deleteById: ",t)}}))}}("../../DB/products.txt");var d=function(t,e,i,r){return new(i||(i=Promise))((function(o,n){function s(t){try{c(r.next(t))}catch(t){n(t)}}function d(t){try{c(r.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,d)}c((r=r.apply(t,e||[])).next())}))},c=function(t,e,i,r){return new(i||(i=Promise))((function(o,n){function s(t){try{c(r.next(t))}catch(t){n(t)}}function d(t){try{c(r.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,d)}c((r=r.apply(t,e||[])).next())}))};class a{constructor(t){this.writeFile=t=>c(this,void 0,void 0,(function*(){try{yield o().promises.writeFile(a.filePath,JSON.stringify(t))}catch(t){console.log("Method: writeFile, ",t)}})),this.readCartFile=()=>c(this,void 0,void 0,(function*(){try{return(yield o().promises.readFile(a.filePath,"utf8"))?JSON.parse(yield o().promises.readFile(a.filePath,"utf8")):[]}catch(t){if(-2===t.errno)try{return yield o().promises.writeFile(a.filePath,JSON.stringify([])),[]}catch(t){console.error("Method: readFile: could not create file in such directory.",t)}else console.log("Method readFile: ",t);return[]}})),this.readProductsFile=()=>c(this,void 0,void 0,(function*(){try{return(yield o().promises.readFile(this.productFilePath,"utf8"))?JSON.parse(yield o().promises.readFile(this.productFilePath,"utf8")):[]}catch(t){if(-2===t.errno)try{return yield o().promises.writeFile(this.productFilePath,JSON.stringify([])),[]}catch(t){console.error("Could not create file in such directory. ",t)}else console.log("Method readFile: ",t);return[]}})),this.createNewCart=()=>c(this,void 0,void 0,(function*(){try{const t=yield this.readCartFile(),e=(new Date).toLocaleString("es-AR");if(0===t.length||void 0===t)return yield this.writeFile([{cartId:1,timestamp:e,products:[]}]),1;{const i=Math.max(...t.map((t=>t.cartId)))+1;return yield this.writeFile([...t,{cartId:i,timestamp:e,products:[]}]),i}}catch(t){return console.error(t),t}})),this.cartDeleteById=t=>c(this,void 0,void 0,(function*(){try{const e=yield this.readCartFile();if(0===e.length||void 0===e)return-1;{const i=e.filter((e=>e.cartId!==t));return i.length===e.length?-2:(yield this.writeFile(i),200)}}catch(t){return console.error(t),t}})),this.getProductsByCartId=t=>c(this,void 0,void 0,(function*(){try{const e=(yield this.readCartFile()).find((e=>e.cartId===t));if(void 0!==e){const t=e.products;return 0===t.length?new Error("Cart has no products."):t}return new Error("Cart not found")}catch(t){return console.error(t),t}})),this.addToCartById=(t,e)=>c(this,void 0,void 0,(function*(){try{const i=Number(e.id),r=yield this.readCartFile(),o=r.find((e=>e.cartId===t)),n=(yield this.readProductsFile()).filter((t=>{if(t.id===i)return t}));if(0===n.length)return new Error(`There is no such product with id= ${i}`);if(void 0!==o&&void 0!==n){const e=[...o.products,...n],i=r.map((i=>i.cartId===t?Object.assign(Object.assign({},i),{products:e}):i));return yield this.writeFile(i),n}}catch(t){return console.error(t),t}})),this.deleteProductByCartId=(t,e)=>c(this,void 0,void 0,(function*(){try{const i=yield this.readCartFile(),r=i.find((e=>e.cartId===t));if(void 0===r)return new Error(`Cart id=${t} not found.`);{const o=r.products.filter((t=>t.id!==e));if(o.length===r.products.length)return new Error(`Product id=${e} not found in cart id=${t}.`);{const e=i.map((e=>e.cartId===t?Object.assign(Object.assign({},e),{products:o}):e));yield this.writeFile(e)}}}catch(t){return console.error(t),t}})),a.filePath=t,this.productFilePath="../../DB/products.txt"}}const l=new a("./api/data/cart.txt");var u=function(t,e,i,r){return new(i||(i=Promise))((function(o,n){function s(t){try{c(r.next(t))}catch(t){n(t)}}function d(t){try{c(r.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,d)}c((r=r.apply(t,e||[])).next())}))};const h=(0,t.Router)();h.get("/products",((t,e)=>d(void 0,void 0,void 0,(function*(){const t=yield s.getAll();e.json(t)})))),h.get("/products/:id",((t,e)=>d(void 0,void 0,void 0,(function*(){const{id:i}=t.params,r=yield s.getById(Number(i));e.json(r)})))),h.post("/products",((t,e)=>d(void 0,void 0,void 0,(function*(){const i=t.body,r=yield s.addProduct(i);e.json(r)})))),h.put("/products/:id",((t,e)=>d(void 0,void 0,void 0,(function*(){const{id:i}=t.params,r=t.body;yield s.updateProductById(Number(i),r),e.json({msg:`Product ${i} updated.`})})))),h.delete("/products/:id",((t,e)=>d(void 0,void 0,void 0,(function*(){const{id:i}=t.params,r=yield s.deleteProductById(Number(i));e.json({deletedProduct:r})})))),h.post("/cart",((t,e)=>u(void 0,void 0,void 0,(function*(){const t=yield l.createNewCart();if("number"!=typeof t)return e.status(500).json({error:-1,msg:"Error creating cart",cartId:t});e.json(t)})))),h.delete("/cart/:id",((t,e)=>u(void 0,void 0,void 0,(function*(){const{id:i}=t.params,r=yield l.cartDeleteById(Number(i));return r instanceof Error?e.status(500).json({error:-1,msg:r.message}):-1===r?e.status(500).json({error:-1,msg:"Cart file is empty!"}):-2===r?e.status(500).json({error:-2,msg:`There is no cart with id= ${i}`}):void e.json(`Cart id: ${i} deleted.`)})))),h.get("/cart/:id/products",((t,e)=>u(void 0,void 0,void 0,(function*(){const{id:i}=t.params,r=yield l.getProductsByCartId(Number(i));if(r instanceof Error)return e.status(500).json({error:-1,msg:r.message});e.json(r)})))),h.post("/cart/:id/products",((t,e)=>u(void 0,void 0,void 0,(function*(){const{id:i}=t.params,r=t.body,o=yield l.addToCartById(Number(i),r);if(o instanceof Error)return e.status(500).json({error:-1,msg:o.message});e.json(o)})))),h.delete("/cart/:id/products/:id_prod",((t,e)=>u(void 0,void 0,void 0,(function*(){const{id:i,id_prod:r}=t.params,o=yield l.deleteProductByCartId(Number(i),Number(r));if(o instanceof Error)return e.status(500).json({error:-1,msg:o.message});e.json(o)}))));const f=h,v=require("dotenv");var y=i.n(v);const p=require("path");var m=i.n(p);const g=require("socket.io"),w={client:"sqlite3",connection:{filename:__dirname+"ecommerce.sqlite"},useNullAsDefault:!0};var b=function(t,e,i,r){return new(i||(i=Promise))((function(o,n){function s(t){try{c(r.next(t))}catch(t){n(t)}}function d(t){try{c(r.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,d)}c((r=r.apply(t,e||[])).next())}))};const F=new class{constructor(t,e){this.productList=[],this.db=i(514)(t),this.table=e,this.createTableIfNotExists()}createTableIfNotExists(){return b(this,void 0,void 0,(function*(){if(!(yield this.db.schema.hasTable(this.table)))try{yield this.db.schema.createTableIfNotExists(this.table,(t=>{t.increments("id").primary(),t.string("title"),t.integer("price"),t.string("thumbnail"),t.integer("timestamp")}))}catch(t){console.error(t)}}))}getAll(){return b(this,void 0,void 0,(function*(){return yield this.db.select("*").from(this.table)}))}getById(t){return b(this,void 0,void 0,(function*(){try{return this.productList.find((e=>e.id===t))||{error:"Product not found."}}catch(t){console.log("Method getById: ",t)}return{error:"Fetch item method failed"}}))}addProduct(t){return b(this,void 0,void 0,(function*(){try{const e=Date.now();yield this.db.insert(Object.assign(Object.assign({},t),{timestamp:e})).into(this.table)}catch(t){console.log("Method save: ",t)}}))}updateProduct(t,e){return b(this,void 0,void 0,(function*(){try{this.productList=this.productList.map((i=>i.id===t?Object.assign(Object.assign({},i),e):i))}catch(t){console.log("Method update: ",t)}}))}deleteProduct(t){return b(this,void 0,void 0,(function*(){try{this.productList=this.productList.filter((e=>e.id!==t))}catch(t){console.log("Method deleteById: ",t)}}))}}({client:"mysql",connection:{host:"127.0.0.1",port:3307,user:"root",password:"",database:"Clase_16"},pool:{min:0,max:7}},"products");var P=function(t,e,i,r){return new(i||(i=Promise))((function(o,n){function s(t){try{c(r.next(t))}catch(t){n(t)}}function d(t){try{c(r.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,d)}c((r=r.apply(t,e||[])).next())}))};const x=new class{constructor(t,e){this.addMessage=({email:t,message:e})=>P(this,void 0,void 0,(function*(){const i=new Date,r=i.toLocaleTimeString(),o=i.toLocaleDateString("es-AR");yield this.db.insert({email:t,message:e,time:r,dateString:o}).into(this.table)})),this.db=i(514)(t),this.table=e,this.createTableIfNotExists()}createTableIfNotExists(){return P(this,void 0,void 0,(function*(){if(!(yield this.db.schema.hasTable(this.table)))try{yield this.db.schema.createTableIfNotExists(this.table,(t=>{t.increments("id").primary(),t.string("email"),t.string("message"),t.string("time"),t.string("dateString")}))}catch(t){console.error(t)}}))}getAllMessages(){return P(this,void 0,void 0,(function*(){return yield this.db.select("*").from(this.table)}))}}(w,"chat");var j=function(t,e,i,r){return new(i||(i=Promise))((function(o,n){function s(t){try{c(r.next(t))}catch(t){n(t)}}function d(t){try{c(r.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(s,d)}c((r=r.apply(t,e||[])).next())}))};y().config();const I=process.env.PORT,N=e()(),O=N.listen(I,(()=>{console.log(`Server listening on port ${I}`)})),C=new g.Server(O);N.use(e().json()),N.use(e().urlencoded({extended:!0})),N.use(((t,e,i)=>{const{isAdmin:r}=t.query;if(!t.originalUrl.includes("/api/cart")&&"true"!==r&&"GET"!==t.method)return e.status(401).json({error:-1,msg:`${t.method}: ${t.originalUrl} --\x3e Unauthorized`});i()})),N.use("/api",f),N.use(e().static(m().join(__dirname,"../public"))),N.use(((t,e,i)=>{if(!t.originalUrl.includes("/api/cart")||!t.originalUrl.includes("/api/products"))return e.status(401).json({error:-2,msg:`${t.method}: ${t.originalUrl} --\x3e Not implemented`});i()})),C.on("connection",(t=>j(void 0,void 0,void 0,(function*(){console.log(`New user connected: ${t.id}`),t.emit("server:products",yield F.getAll()),t.emit("server:message",yield x.getAllMessages()),t.on("client:product",(t=>j(void 0,void 0,void 0,(function*(){F.addProduct(t),C.emit("server:products",yield F.getAll())})))),t.on("client:message",(t=>j(void 0,void 0,void 0,(function*(){x.addMessage(t),C.emit("server:message",yield x.getAllMessages())}))))}))))})()})();